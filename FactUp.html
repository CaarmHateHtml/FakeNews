<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FactUp</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; }
    input[type=range] { cursor: pointer; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    @keyframes bubble-pop { 0%{transform:translate(-50%,-50%) scale(0.5);opacity:0} 60%{transform:translate(-50%,-50%) scale(1.1)} 100%{transform:translate(-50%,-50%) scale(1);opacity:1} }
    @keyframes bubble-pulse { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.5)} 50%{box-shadow:0 0 0 10px rgba(239,68,68,0)} }
    @keyframes bubble-pulse-real { 0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.4)} 50%{box-shadow:0 0 0 10px rgba(34,197,94,0)} }
    @keyframes slide-up { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
    @keyframes shake { 0%,100%{transform:translate(-50%,-50%) rotate(0deg)} 25%{transform:translate(-50%,-50%) rotate(-3deg)} 75%{transform:translate(-50%,-50%) rotate(3deg)} }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ===================== SETTINGS =====================
const DEFAULT_SETTINGS = {
  theme: "dark", language: "vi", sound: true, music: false,
  volume: 70, gameSpeed: "normal", notifications: true,
  fontSize: "medium", colorBlind: false, autoSave: true,
};

const T = {
  vi: {
    appName:"FactUp", menu:"Menu", simulation:"M√¥ ph·ªèng", practice:"Luy·ªán t·∫≠p",
    missions:"Nhi·ªám v·ª•", tools:"C√¥ng c·ª•", profile:"H·ªì s∆°", settings:"C√†i ƒë·∫∑t",
    back:"‚Üê Quay l·∫°i", streak:"STREAK", gem:"GEM", ticket:"TICKET",
    gemShop:"C·ª≠a h√†ng Gem", gemShopDesc:"Mua Khung avatar, Background h·ªì s∆°, Danh hi·ªáu, Style ghi ch√∫, Huy hi·ªáu",
    gacha:"Quay v·∫≠t ph·∫©m", gachaDesc:"D√πng Ticket ƒë·ªÉ quay: Skin icon MXH, Theme b·∫£n ƒë·ªì",
    settingsTitle:"C√†i ƒë·∫∑t", appearance:"Giao di·ªán", themeLabel:"Ch·∫ø ƒë·ªô m√†u",
    dark:"T·ªëi", light:"S√°ng", languageLabel:"Ng√¥n ng·ªØ", fontSizeLabel:"C·ª° ch·ªØ",
    small:"Nh·ªè", medium:"V·ª´a", large:"L·ªõn", colorBlindLabel:"H·ªó tr·ª£ m√†u m√π",
    audio:"√Çm thanh", soundLabel:"Hi·ªáu ·ª©ng √¢m thanh", musicLabel:"Nh·∫°c n·ªÅn", volumeLabel:"√Çm l∆∞·ª£ng",
    gameplay:"Gameplay", gameSpeedLabel:"T·ªëc ƒë·ªô game",
    slow:"Ch·∫≠m", normal:"Th∆∞·ªùng", fast:"Nhanh",
    notificationsLabel:"Th√¥ng b√°o s·ª± ki·ªán", autoSaveLabel:"T·ª± ƒë·ªông l∆∞u ti·∫øn tr√¨nh",
    account:"T√†i kho·∫£n & D·ªØ li·ªáu", resetProgress:"ƒê·∫∑t l·∫°i ti·∫øn tr√¨nh",
    resetProgressDesc:"X√≥a to√†n b·ªô d·ªØ li·ªáu game, v·ªÅ tr·∫°ng th√°i m·ªõi tinh",
    resetBtn:"ƒê·∫∑t l·∫°i ngay", resetConfirmTxt:"B·∫°n c√≥ ch·∫Øc? Kh√¥ng th·ªÉ ho√†n t√°c!",
    resetDoneTxt:"‚úÖ ƒê√£ ƒë·∫∑t l·∫°i v·ªÅ m·ªõi tinh!", saveSettings:"L∆∞u c√†i ƒë·∫∑t", saved:"‚úÖ ƒê√£ l∆∞u!",
    day:"Ng√†y", ap:"AP", spreadProgress:"H·ªón lo·∫°n", zoneStatus:"T√¨nh tr·∫°ng",
    spreadSpeed:"M·ª©c h·ªón lo·∫°n", influence:"M·ª©c ·∫£nh h∆∞·ªüng", control:"ƒê·ªô ki·ªÉm so√°t", pressure:"√Åp l·ª±c",
    skills:"K·ªπ nƒÉng", investigate:"üîç Ki·ªÉm tra ngu·ªìn", clarify:"üì¢ ƒê√≠nh ch√≠nh", boost:"üõ° TƒÉng ki·ªÉm so√°t",
    globalStatus:"To√†n h·ªá th·ªëng", socialInfluence:"·∫¢nh h∆∞·ªüng x√£ h·ªôi", globalSpeed:"T·ªëc ƒë·ªô to√†n c·ª•c",
    publicPressure:"√Åp l·ª±c d∆∞ lu·∫≠n", systemStatus:"H·ªá th·ªëng ki·ªÉm so√°t", zones:"C√°c khu v·ª±c",
    eventLog:"üìã L·ªãch s·ª≠ s·ª± ki·ªán", newAlert:"‚ö†Ô∏è Tin m·ªõi", fake:"Tin gi·∫£", real:"Th·∫≠t",
    win:"Chi·∫øn th·∫Øng!", lose:"Th·∫•t b·∫°i!", winMsg:"B·∫°n ƒë√£ ki·ªÉm so√°t to√†n b·ªô tin gi·∫£!",
    loseMsg:"Tin gi·∫£ ƒë√£ tr√†n ng·∫≠p to√†n h·ªá th·ªëng MXH!", playAgain:"Ch∆°i l·∫°i",
    notEnoughAP:"Kh√¥ng ƒë·ªß AP!", practiceTitle:"Luy·ªán t·∫≠p", confirm:"X√°c nh·∫≠n",
    next:"Ti·∫øp theo ‚ñ∂‚ñ∂", finish:"Ho√†n th√†nh üéâ", correct:"‚úÖ Ch√≠nh x√°c!", wrong:"‚ùå Ch∆∞a ƒë√∫ng.",
    playerLabel:"Ng∆∞·ªùi ch∆°i", uid:"UID", level:"Level", achievements:"Th√†nh t·ª±u",
    chain:"Chu·ªói", medals:"Huy ch∆∞∆°ng", preview:"XEM TR∆Ø·ªöC",
    colorBlindDesc:"Thay m√†u xanh l√° b·∫±ng xanh d∆∞∆°ng",
    gameSpeedDesc:"·∫¢nh h∆∞·ªüng t·ªëc ƒë·ªô lan truy·ªÅn tin gi·∫£",
    notifDesc:"Hi·ªán popup khi c√≥ tin m·ªõi kh·∫©n c·∫•p",
    autoSaveDesc:"T·ª± ƒë·ªông l∆∞u ti·∫øn tr√¨nh m·ªói 60 gi√¢y",
    gems:"gems", tickets:"tickets",
    chooseDifficulty:"Ch·ªçn ƒë·ªô kh√≥",
    easy:"D·ªÖ", normal2:"B√¨nh th∆∞·ªùng", hard:"Kh√≥",
    easyDesc:"√çt tin xu·∫•t hi·ªán, t·ªëc ƒë·ªô lan ch·∫≠m, nhi·ªÅu th·ªùi gian ph·∫£n ·ª©ng",
    normalDesc:"C√¢n b·∫±ng gi·ªØa t·ªëc ƒë·ªô v√† s·ªë l∆∞·ª£ng tin t·ª©c",
    hardDesc:"Tin li√™n t·ª•c xu·∫•t hi·ªán, lan nhanh, AP h·ªìi ch·∫≠m",
    startGame:"B·∫Øt ƒë·∫ßu",
    bubbleFake:"üì∞ Tin gi·∫£", bubbleReal:"üìÑ Tin th·∫≠t",
    investigateDesc:"Ki·ªÉm tra ngu·ªìn tin (2 AP)", clarifyDesc:"Gi·∫£m h·ªón lo·∫°n (3 AP)", boostDesc:"Gi·∫£m tin fake xu·∫•t hi·ªán (4 AP)",
    sourceLabel:"Ngu·ªìn:", sourceOfficial:"B√°o ch√≠nh th·ªëng ‚úÖ", sourcePost:"B√†i ƒëƒÉng v√¥ danh ‚ö†Ô∏è", sourceScreenshot:"Tin nh·∫Øn ch·ª•p m√†n h√¨nh ‚ö†Ô∏è", sourceGov:"C∆° quan ch√≠nh ph·ªß ‚úÖ",
    trustworthy:"Ngu·ªìn ƒë√°ng tin c·∫≠y ‚Äî kh√¥ng c·∫ßn x·ª≠ l√Ω", untrustworthy:"Ngu·ªìn kh√¥ng uy t√≠n ‚Äî c·∫ßn ƒë√≠nh ch√≠nh!",
    dismiss:"B·ªè qua", clarifyNow:"ƒê√≠nh ch√≠nh ngay (3AP)",
    chaosWarning:"H·ªón lo·∫°n v∆∞·ª£t 80%!", chaosLevel:"M·ª©c h·ªón lo·∫°n MXH",
    apRegen:"AP h·ªìi m·ªói 20 gi√¢y",
  },
  en: {
    appName:"FactUp", menu:"Menu", simulation:"Simulation", practice:"Practice",
    missions:"Missions", tools:"Tools", profile:"Profile", settings:"Settings",
    back:"‚Üê Back", streak:"STREAK", gem:"GEM", ticket:"TICKET",
    gemShop:"Gem Shop", gemShopDesc:"Buy avatar frames, profile backgrounds, titles, note styles, badges",
    gacha:"Spin Items", gachaDesc:"Use Tickets to spin: Social media skins, Map themes",
    settingsTitle:"Settings", appearance:"Appearance", themeLabel:"Color Mode",
    dark:"Dark", light:"Light", languageLabel:"Language", fontSizeLabel:"Font Size",
    small:"Small", medium:"Medium", large:"Large", colorBlindLabel:"Color Blind Mode",
    audio:"Audio", soundLabel:"Sound Effects", musicLabel:"Background Music", volumeLabel:"Volume",
    gameplay:"Gameplay", gameSpeedLabel:"Game Speed",
    slow:"Slow", normal:"Normal", fast:"Fast",
    notificationsLabel:"Event Notifications", autoSaveLabel:"Auto-save Progress",
    account:"Account & Data", resetProgress:"Reset Progress",
    resetProgressDesc:"Clear all game data and start fresh",
    resetBtn:"Reset Now", resetConfirmTxt:"Are you sure? Cannot be undone!",
    resetDoneTxt:"‚úÖ Progress has been reset!", saveSettings:"Save Settings", saved:"‚úÖ Saved!",
    day:"Day", ap:"AP", spreadProgress:"Chaos", zoneStatus:"Status",
    spreadSpeed:"Chaos Level", influence:"Influence", control:"Control", pressure:"Pressure",
    skills:"Skills", investigate:"üîç Investigate Source", clarify:"üì¢ Clarify", boost:"üõ° Boost Control",
    globalStatus:"Global Status", socialInfluence:"Social Influence", globalSpeed:"Global Speed",
    publicPressure:"Public Pressure", systemStatus:"Control System", zones:"Zones",
    eventLog:"üìã Event Log", newAlert:"‚ö†Ô∏è New Alert", fake:"Fake", real:"Real",
    win:"Victory!", lose:"Defeat!", winMsg:"You controlled all fake news!",
    loseMsg:"Fake news has flooded all social media!", playAgain:"Play Again",
    notEnoughAP:"Not enough AP!", practiceTitle:"Practice", confirm:"Confirm",
    next:"Next ‚ñ∂‚ñ∂", finish:"Finish üéâ", correct:"‚úÖ Correct!", wrong:"‚ùå Incorrect.",
    playerLabel:"Player", uid:"UID", level:"Level", achievements:"Achievements",
    chain:"Streak", medals:"Medals", preview:"PREVIEW",
    colorBlindDesc:"Replace green with blue for accessibility",
    gameSpeedDesc:"Affects how fast fake news spreads",
    notifDesc:"Show popup when urgent news appears",
    autoSaveDesc:"Auto-save progress every 60 seconds",
    gems:"gems", tickets:"tickets",
    chooseDifficulty:"Choose Difficulty",
    easy:"Easy", normal2:"Normal", hard:"Hard",
    easyDesc:"Fewer news bubbles, slower spread, more reaction time",
    normalDesc:"Balanced speed and news frequency",
    hardDesc:"Constant news, fast spread, slow AP regen",
    startGame:"Start Game",
    bubbleFake:"üì∞ Fake News", bubbleReal:"üìÑ Real News",
    investigateDesc:"Check news source (2 AP)", clarifyDesc:"Reduce chaos (3 AP)", boostDesc:"Reduce fake news rate (4 AP)",
    sourceLabel:"Source:", sourceOfficial:"Official news outlet ‚úÖ", sourcePost:"Anonymous post ‚ö†Ô∏è", sourceScreenshot:"Screenshot message ‚ö†Ô∏è", sourceGov:"Government agency ‚úÖ",
    trustworthy:"Trustworthy source ‚Äî no action needed", untrustworthy:"Untrustworthy source ‚Äî clarification needed!",
    dismiss:"Dismiss", clarifyNow:"Clarify Now (3AP)",
    chaosWarning:"Chaos exceeds 80%!", chaosLevel:"Social Media Chaos",
    apRegen:"AP regens every 20s",
  }
};

function getTheme(mode) {
  if (mode === "light") return {
    bg:"#f0eff8", surface:"#ffffff", surface2:"#f5f3ff", border:"#e2dff5",
    border2:"#ccc8ee", text:"#1a1530", text2:"#4a4070", text3:"#8b84a8",
    accent:"#7c3aed", accent2:"#db2777", accentBg:"#7c3aed15",
    headerBg:"#ffffff", mapBg:"#ece8ff", mapDot:"#7c3aed12",
    toggleOff:"#d5d0ef", inputBg:"#f5f3ff",
  };
  return {
    bg:"#0f0e1a", surface:"#18172b", surface2:"#1e1d32", border:"#2d2d4e",
    border2:"#3d3d5e", text:"#e2e8f0", text2:"#c4b5fd", text3:"#6b7280",
    accent:"#a78bfa", accent2:"#f472b6", accentBg:"#a78bfa22",
    headerBg:"#18172b", mapBg:"#0a0918", mapDot:"#2d2d4e22",
    toggleOff:"#2d2d4e", inputBg:"#0f0e1a",
  };
}

// ===================== DATA =====================
const ZONES = {
  facebook:  {id:"facebook",  name:"Facebook",  icon:"üìò", x:22, y:30},
  tiktok:    {id:"tiktok",    name:"TikTok",    icon:"üéµ", x:65, y:18},
  instagram: {id:"instagram", name:"Instagram", icon:"üì∏", x:72, y:62},
  youtube:   {id:"youtube",   name:"YouTube",   icon:"‚ñ∂Ô∏è", x:28, y:68},
};

// News bubbles data pool
const NEWS_POOL = [
  {title:"U·ªëng n∆∞·ªõc chanh l√∫c 6h s√°ng ch·ªØa ƒë∆∞·ª£c ung th∆∞!", source:"screenshot", isFake:true, urgency:3},
  {title:"Tu·∫ßn t·ªõi th√†nh ph·ªë cho h·ªçc sinh ngh·ªâ h·ªçc v√¨ d·ªãch b·ªánh.", source:"post", isFake:true, urgency:2},
  {title:"NASA x√°c nh·∫≠n: Tr√°i ƒê·∫•t s·∫Ω t·ªëi 3 ng√†y v√†o th√°ng 12!", source:"post", isFake:true, urgency:3},
  {title:"B·ªô Y t·∫ø ra th√¥ng b√°o v·ªÅ l·ªãch ti√™m vaccine m·ªõi.", source:"gov", isFake:false, urgency:1},
  {title:"Ch√≠nh ph·ªß tƒÉng l∆∞∆°ng t·ªëi thi·ªÉu 6% t·ª´ th√°ng 7.", source:"official", isFake:false, urgency:1},
  {title:"5G g√¢y ung th∆∞ ‚Äî H√£y chia s·∫ª ngay cho ng∆∞·ªùi th√¢n!!!", source:"screenshot", isFake:true, urgency:3},
  {title:"ƒÇn t·ªèi m·ªói ng√†y ngƒÉn ng·ª´a COVID ho√†n to√†n!", source:"post", isFake:true, urgency:2},
  {title:"B·ªô Gi√°o d·ª•c c√¥ng b·ªë l·ªãch thi t·ªët nghi·ªáp THPT 2026.", source:"gov", isFake:false, urgency:1},
  {title:"Vaccine m·ªõi c√≥ chip theo d√µi t·ª´ t·ªâ ph√∫ n∆∞·ªõc ngo√†i!", source:"screenshot", isFake:true, urgency:3},
  {title:"B√£o s·ªë 5 ƒë·ªï b·ªô v√†o mi·ªÅn Trung theo d·ª± b√°o kh√≠ t∆∞·ª£ng.", source:"official", isFake:false, urgency:2},
  {title:"U·ªëng c√† ph√™ m·ªói s√°ng tƒÉng tu·ªïi th·ªç 10 nƒÉm ‚Äî s·ª± th·∫≠t!", source:"post", isFake:true, urgency:2},
  {title:"Th√†nh ph·ªë H√† N·ªôi th√¥ng b√°o ngh·ªâ l·ªÖ 30/4 - 1/5 k√©o d√†i.", source:"gov", isFake:false, urgency:1},
];

const SOURCE_LABELS = {
  official: {vi:"B√°o ch√≠nh th·ªëng ‚úÖ", en:"Official outlet ‚úÖ"},
  post: {vi:"B√†i ƒëƒÉng v√¥ danh ‚ö†Ô∏è", en:"Anonymous post ‚ö†Ô∏è"},
  screenshot: {vi:"Tin nh·∫Øn ch·ª•p m√†n h√¨nh ‚ö†Ô∏è", en:"Screenshot message ‚ö†Ô∏è"},
  gov: {vi:"C∆° quan ch√≠nh ph·ªß ‚úÖ", en:"Government agency ‚úÖ"},
};

// Difficulty configs
const DIFFICULTY = {
  easy:   { bubbleInterval:12, maxBubbles:2, chaosRate:0.15, fakeRatio:0.5, apStart:7, apRegenSec:20, chaosDecay:0.3, clarifyEffect:25, boostEffect:30 },
  normal: { bubbleInterval:8,  maxBubbles:4, chaosRate:0.28, fakeRatio:0.6, apStart:5, apRegenSec:20, chaosDecay:0.2, clarifyEffect:18, boostEffect:22 },
  hard:   { bubbleInterval:5,  maxBubbles:7, chaosRate:0.5,  fakeRatio:0.7, apStart:5, apRegenSec:25, chaosDecay:0.1, clarifyEffect:12, boostEffect:15 },
};

const PRACTICE_QS = [
  {
    type:"identify_flags",
    title:"T√¨m d·∫•u hi·ªáu ƒë√°ng ng·ªù trong ƒëo·∫°n tin",
    content:"üî• C·∫¢NH B√ÅO KH·∫®N!!!\nTheo m·ªôt ngu·ªìn tin ƒë√°ng tin c·∫≠y, u·ªëng n∆∞·ªõc X m·ªói ng√†y s·∫Ω gi√∫p tƒÉng IQ.\nNhi·ªÅu ng∆∞·ªùi ƒë√£ th·ª≠ v√† th√†nh c√¥ng!\nH√£y chia s·∫ª ngay cho ng∆∞·ªùi th√¢n!!!",
    options:[
      {text:'"Theo m·ªôt ngu·ªìn tin ƒë√°ng tin c·∫≠y" ‚Üí m∆° h·ªì', correct:true},
      {text:'"TƒÉng IQ" ‚Üí tuy√™n b·ªë phi th·ª±c t·∫ø', correct:true},
      {text:'"H√£y chia s·∫ª ngay" ‚Üí k√™u g·ªçi lan truy·ªÅn', correct:true},
      {text:'N·ªôi dung c√≥ logo ch√≠nh th·ª©c', correct:false},
    ],
    explanation:"Tin gi·∫£ th∆∞·ªùng d√πng ngu·ªìn m∆° h·ªì, tuy√™n b·ªë phi th·ª±c t·∫ø v√† k√™u g·ªçi lan truy·ªÅn g·∫•p.",
  },
  {
    type:"choose_source",
    title:"Ch·ªçn ngu·ªìn tin uy t√≠n",
    scenario:'B·∫°n nghe tin: "Tu·∫ßn t·ªõi th√†nh ph·ªë s·∫Ω cho h·ªçc sinh ngh·ªâ h·ªçc v√¨ d·ªãch b·ªánh."',
    sources:[
      {name:'Fanpage "Tin N√≥ng 24/7"', details:['Nhi·ªÅu l∆∞·ª£t share','Kh√¥ng ghi ngu·ªìn g·ªëc'], correct:false},
      {name:'Website S·ªü Gi√°o d·ª•c th√†nh ph·ªë', details:['C√≥ th√¥ng b√°o ch√≠nh th·ª©c','C·∫≠p nh·∫≠t th·ªùi gian r√µ r√†ng'], correct:true},
      {name:'Video TikTok c·ªßa m·ªôt ng∆∞·ªùi l·∫°', details:['Gi·ªçng kh·∫≥ng ƒë·ªãnh ch·∫Øc ch·∫Øn','Kh√¥ng d·∫´n ch·ª©ng'], correct:false},
    ],
  },
  {
    type:"verify_methods",
    title:"Ch·ªçn c√°ch ki·ªÉm ch·ª©ng th√¥ng tin",
    scenario:'B·∫°n nghe tin: "Tu·∫ßn t·ªõi th√†nh ph·ªë s·∫Ω cho h·ªçc sinh ngh·ªâ h·ªçc v√¨ d·ªãch b·ªánh."',
    methods:[
      {text:'T√¨m website c∆° quan ch√≠nh th·ª©c', correct:true},
      {text:'Ki·ªÉm tra b√°o ch√≠nh th·ªëng', correct:true},
      {text:'Xem b√¨nh lu·∫≠n MXH', correct:false},
      {text:'H·ªèi b·∫°n b√® trong nh√≥m chat', correct:false},
    ],
  },
  {
    type:"classify_post",
    title:"Ph√¢n lo·∫°i b√†i ƒëƒÉng n√†y",
    post:{image:"üë©‚Äçüíª", caption:"ƒê√¢y l√† s·ª± th·∫≠t b·∫°n c·∫ßn bi·∫øt ngay!\nKhoa h·ªçc v·ª´a ch·ª©ng minh: Ng·ªß √≠t h∆°n 5 ti·∫øng m·ªói ng√†y gi√∫p n√£o ho·∫°t ƒë·ªông t·ªët h∆°n!\nH√£y th·ª≠ v√† chia s·∫ª k·∫øt qu·∫£ nh√©! üí™üî•"},
    flags:["Gi·∫≠t t√≠t/ƒë√°nh v√†o c·∫£m x√∫c","Kh√¥ng c√≥ ngu·ªìn g·ªëc","G√¢y hi·ªÉu l·∫ßm"],
    verdict_options:["Tin gi·∫£","Th·∫≠t","Kh√¥ng li√™n quan"],
    correct_verdict:"Tin gi·∫£",
    correct_flags:["Gi·∫≠t t√≠t/ƒë√°nh v√†o c·∫£m x√∫c","Kh√¥ng c√≥ ngu·ªìn g·ªëc","G√¢y hi·ªÉu l·∫ßm"],
  },
];

// ===================== HELPERS =====================
const toChaos = (v,l) => {
  const vi=["·ªîn ƒë·ªãnh","Lo ng·∫°i","B·∫•t ·ªïn","H·ªón lo·∫°n","Kh·ªßng ho·∫£ng"];
  const en=["Stable","Concerning","Unstable","Chaotic","Crisis"];
  const c=["#22c55e","#86efac","#facc15","#f97316","#ef4444"];
  const i=v<=15?0:v<=35?1:v<=55?2:v<=75?3:4;
  return {label:(l==="en"?en:vi)[i],color:c[i]};
};
const toInfluence = (v,l) => {
  const vi=["Nh·ªè","V·ª´a","R·ªông","Nghi√™m tr·ªçng"]; const en=["Minor","Moderate","Wide","Critical"];
  const c=["#22c55e","#facc15","#f97316","#ef4444"]; const i=v<=25?0:v<=50?1:v<=75?2:3;
  return {label:(l==="en"?en:vi)[i],color:c[i]};
};
const toControl = (v,l) => {
  const vi=["Y·∫øu","Kh√¥ng ·ªïn ƒë·ªãnh","·ªîn ƒë·ªãnh","T·ªët","Ki·ªÉm so√°t t·ªët"]; const en=["Weak","Unstable","Stable","Good","Full Control"];
  const c=["#ef4444","#f97316","#facc15","#86efac","#22c55e"]; const i=v<=20?0:v<=40?1:v<=60?2:v<=80?3:4;
  return {label:(l==="en"?en:vi)[i],color:c[i]};
};
const toPressure = (v,l) => {
  const vi=["Th·∫•p","TƒÉng d·∫ßn","Cao","R·∫•t cao"]; const en=["Low","Rising","High","Critical"];
  const c=["#22c55e","#facc15","#f97316","#ef4444"]; const i=v<=25?0:v<=50?1:v<=75?2:3;
  return {label:(l==="en"?en:vi)[i],color:c[i]};
};
const zoneColor = (v,cb) => {
  if (cb) return v<=30?"#3b82f6":v<=60?"#f59e0b":"#ef4444";
  return v<=30?"#22c55e":v<=60?"#eab308":"#ef4444";
};

const freshZones = () => ({
  facebook: {chaos:0,control:100,influence:0,pressure:0,bubbles:[],boostActive:0},
  tiktok:   {chaos:0,control:100,influence:0,pressure:0,bubbles:[],boostActive:0},
  instagram:{chaos:0,control:100,influence:0,pressure:0,bubbles:[],boostActive:0},
  youtube:  {chaos:0,control:100,influence:0,pressure:0,bubbles:[],boostActive:0},
});
const freshPlayer = () => ({streak:0,gems:0,tickets:0,level:1,xp:0,medals:[]});

// ===================== SMALL COMPONENTS =====================
function Toggle({value,onChange,th}) {
  return (
    <div onClick={()=>onChange(!value)} style={{width:44,height:24,borderRadius:99,cursor:"pointer",background:value?th.accent:th.toggleOff,position:"relative",transition:"background 0.3s",flexShrink:0}}>
      <div style={{position:"absolute",top:3,left:value?23:3,width:18,height:18,borderRadius:"50%",background:"#fff",transition:"left 0.3s",boxShadow:"0 1px 4px #0005"}}/>
    </div>
  );
}
function SegBtn({active,label,onClick,th}) {
  return <button onClick={onClick} style={{padding:"6px 14px",borderRadius:8,border:"none",cursor:"pointer",fontSize:13,fontWeight:600,background:active?th.accent:th.toggleOff,color:active?"#fff":th.text2,transition:"all 0.2s"}}>{label}</button>;
}
function SRow({label,desc,children,th}) {
  return (
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"13px 0",borderBottom:`1px solid ${th.border}`}}>
      <div><div style={{color:th.text,fontSize:14,fontWeight:600}}>{label}</div>{desc&&<div style={{color:th.text3,fontSize:12,marginTop:2}}>{desc}</div>}</div>
      <div style={{flexShrink:0,marginLeft:16}}>{children}</div>
    </div>
  );
}
function Badge({label,color}) {
  return <span style={{background:color+"22",color,border:`1px solid ${color}55`,borderRadius:6,padding:"2px 10px",fontWeight:700,fontSize:13}}>{label}</span>;
}
function APBar({ap,maxAP,th}) {
  return <div style={{display:"flex",gap:3}}>{Array.from({length:maxAP}).map((_,i)=><div key={i} style={{width:10,height:10,borderRadius:2,background:i<ap?th.accent:th.border,border:`1px solid ${th.border2}`,transition:"background 0.3s"}}/>)}</div>;
}
function SectionHead({title,th}) {
  return <div style={{fontSize:11,fontWeight:800,letterSpacing:1.5,color:th.accent,textTransform:"uppercase",marginBottom:10,marginTop:6}}>{title}</div>;
}
function Card({children,th,style={}}) {
  return <div style={{background:th.surface,borderRadius:16,border:`1px solid ${th.border}`,padding:"4px 20px",marginBottom:22,...style}}>{children}</div>;
}

// ===================== SETTINGS SCREEN =====================
function SettingsScreen({onBack,settings,onSave}) {
  const [local,setLocal]=useState({...settings});
  const [savedMsg,setSavedMsg]=useState(false);
  const [resetStep,setResetStep]=useState(0);
  const th=getTheme(local.theme);
  const t=T[local.language];
  const set=(k,v)=>setLocal(s=>({...s,[k]:v}));
  const handleSave=()=>{onSave(local);setSavedMsg(true);setTimeout(()=>setSavedMsg(false),2000);};
  const handleReset=()=>{
    if(resetStep===0){setResetStep(1);return;}
    onSave({...local,_reset:true});setResetStep(2);setTimeout(()=>setResetStep(0),3000);
  };
  return (
    <div style={{minHeight:"100vh",background:th.bg,fontFamily:"'Segoe UI',sans-serif",color:th.text}}>
      <div style={{background:th.headerBg,borderBottom:`1px solid ${th.border}`,padding:"13px 24px",display:"flex",alignItems:"center",gap:14,position:"sticky",top:0,zIndex:10}}>
        <button onClick={onBack} style={{background:th.surface2,border:`1px solid ${th.border}`,borderRadius:8,color:th.text2,padding:"7px 16px",cursor:"pointer",fontWeight:600,fontSize:13}}>{t.back}</button>
        <span style={{fontWeight:800,fontSize:18,color:th.text}}>{t.settingsTitle}</span>
        <div style={{flex:1}}/>
        {savedMsg&&<span style={{color:"#22c55e",fontWeight:700,fontSize:13}}>{t.saved}</span>}
        <button onClick={handleSave} style={{background:`linear-gradient(135deg,${th.accent},${th.accent2})`,border:"none",borderRadius:10,color:"#fff",padding:"9px 24px",fontWeight:700,fontSize:14,cursor:"pointer"}}>{t.saveSettings}</button>
      </div>
      <div style={{maxWidth:640,margin:"0 auto",padding:"30px 24px"}}>
        <SectionHead title={t.appearance} th={th}/>
        <Card th={th}>
          <SRow label={t.themeLabel} th={th}>
            <div style={{display:"flex",gap:6}}>
              <SegBtn active={local.theme==="dark"} label={"üåô "+t.dark} onClick={()=>set("theme","dark")} th={th}/>
              <SegBtn active={local.theme==="light"} label={"‚òÄÔ∏è "+t.light} onClick={()=>set("theme","light")} th={th}/>
            </div>
          </SRow>
          <SRow label={t.languageLabel} th={th}>
            <div style={{display:"flex",gap:6}}>
              <SegBtn active={local.language==="vi"} label="üáªüá≥ Ti·∫øng Vi·ªát" onClick={()=>set("language","vi")} th={th}/>
              <SegBtn active={local.language==="en"} label="üá¨üáß English" onClick={()=>set("language","en")} th={th}/>
            </div>
          </SRow>
          <SRow label={t.fontSizeLabel} th={th}>
            <div style={{display:"flex",gap:5}}>
              <SegBtn active={local.fontSize==="small"} label={t.small} onClick={()=>set("fontSize","small")} th={th}/>
              <SegBtn active={local.fontSize==="medium"} label={t.medium} onClick={()=>set("fontSize","medium")} th={th}/>
              <SegBtn active={local.fontSize==="large"} label={t.large} onClick={()=>set("fontSize","large")} th={th}/>
            </div>
          </SRow>
          <SRow label={t.colorBlindLabel} desc={t.colorBlindDesc} th={th}>
            <Toggle value={local.colorBlind} onChange={v=>set("colorBlind",v)} th={th}/>
          </SRow>
        </Card>
        <SectionHead title={t.audio} th={th}/>
        <Card th={th}>
          <SRow label={t.soundLabel} th={th}><Toggle value={local.sound} onChange={v=>set("sound",v)} th={th}/></SRow>
          <SRow label={t.musicLabel} th={th}><Toggle value={local.music} onChange={v=>set("music",v)} th={th}/></SRow>
          <SRow label={t.volumeLabel} th={th}>
            <div style={{display:"flex",alignItems:"center",gap:10}}>
              <span style={{color:th.text3,fontSize:12,minWidth:32,textAlign:"right"}}>{local.volume}%</span>
              <input type="range" min={0} max={100} value={local.volume} onChange={e=>set("volume",+e.target.value)} style={{width:120,accentColor:th.accent}}/>
            </div>
          </SRow>
        </Card>
        <SectionHead title={t.gameplay} th={th}/>
        <Card th={th}>
          <SRow label={t.gameSpeedLabel} desc={t.gameSpeedDesc} th={th}>
            <div style={{display:"flex",gap:5}}>
              <SegBtn active={local.gameSpeed==="slow"} label={"üê¢ "+t.slow} onClick={()=>set("gameSpeed","slow")} th={th}/>
              <SegBtn active={local.gameSpeed==="normal"} label={"‚ñ∂ "+t.normal} onClick={()=>set("gameSpeed","normal")} th={th}/>
              <SegBtn active={local.gameSpeed==="fast"} label={"‚ö° "+t.fast} onClick={()=>set("gameSpeed","fast")} th={th}/>
            </div>
          </SRow>
          <SRow label={t.notificationsLabel} desc={t.notifDesc} th={th}>
            <Toggle value={local.notifications} onChange={v=>set("notifications",v)} th={th}/>
          </SRow>
          <SRow label={t.autoSaveLabel} desc={t.autoSaveDesc} th={th}>
            <Toggle value={local.autoSave} onChange={v=>set("autoSave",v)} th={th}/>
          </SRow>
        </Card>
        <SectionHead title={t.account} th={th}/>
        <Card th={th}>
          <SRow label={t.resetProgress} desc={t.resetProgressDesc} th={th}>
            <button onClick={handleReset} style={{
              background:resetStep===1?"#ef444422":th.surface2,
              border:`1px solid ${resetStep===1?"#ef4444":th.border2}`,
              borderRadius:8,color:resetStep===1?"#ef4444":th.text2,
              padding:"7px 16px",cursor:"pointer",fontWeight:700,fontSize:13,transition:"all 0.2s",
            }}>{resetStep===1?t.resetConfirmTxt:t.resetBtn}</button>
          </SRow>
          {resetStep===2&&<div style={{padding:"10px 0",color:"#22c55e",fontWeight:700,fontSize:14}}>{t.resetDoneTxt}</div>}
        </Card>
        <SectionHead title={t.preview} th={th}/>
        <div style={{background:th.surface,borderRadius:16,border:`1px solid ${th.border}`,padding:20,marginBottom:36}}>
          <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}}>
            {(local.colorBlind?["#3b82f6","#f59e0b","#ef4444","#a78bfa","#f472b6"]:["#22c55e","#eab308","#ef4444","#a78bfa","#f472b6"]).map((c,i)=>(
              <div key={i} style={{width:34,height:34,borderRadius:8,background:c}}/>
            ))}
            <div style={{marginLeft:12,flex:1}}>
              <div style={{fontSize:local.fontSize==="small"?11:local.fontSize==="large"?18:14,color:th.text,fontWeight:600,marginBottom:4}}>C·ª° ch·ªØ hi·ªán t·∫°i</div>
              <div style={{fontSize:11,color:th.text3}}>Ch·∫ø ƒë·ªô: {local.theme==="dark"?"üåô T·ªëi":"‚òÄÔ∏è S√°ng"} ¬∑ T·ªëc ƒë·ªô: {local.gameSpeed}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ===================== DIFFICULTY SELECT SCREEN =====================
function DifficultyScreen({onStart,onBack,th,t}) {
  const [selected,setSelected]=useState("normal");
  const opts=[
    {id:"easy", emoji:"üü¢", label:t.easy, desc:t.easyDesc,
     stats:["ü´ß √çt bong b√≥ng tin t·ª©c","‚è± Xu·∫•t hi·ªán m·ªói 12 gi√¢y","‚ö° B·∫Øt ƒë·∫ßu v·ªõi 7 AP","üå° T·ªëc ƒë·ªô h·ªón lo·∫°n ch·∫≠m"]},
    {id:"normal", emoji:"üü°", label:t.normal2, desc:t.normalDesc,
     stats:["ü´ß S·ªë bong b√≥ng v·ª´a ph·∫£i","‚è± Xu·∫•t hi·ªán m·ªói 8 gi√¢y","‚ö° B·∫Øt ƒë·∫ßu v·ªõi 5 AP","üå° T·ªëc ƒë·ªô h·ªón lo·∫°n v·ª´a"]},
    {id:"hard", emoji:"üî¥", label:t.hard, desc:t.hardDesc,
     stats:["ü´ß R·∫•t nhi·ªÅu bong b√≥ng","‚è± Xu·∫•t hi·ªán m·ªói 5 gi√¢y","‚ö° B·∫Øt ƒë·∫ßu v·ªõi 5 AP","üå° H·ªón lo·∫°n tƒÉng r·∫•t nhanh"]},
  ];
  return (
    <div style={{minHeight:"100vh",background:th.bg,fontFamily:"'Segoe UI',sans-serif",display:"flex",flexDirection:"column"}}>
      <div style={{background:th.headerBg,borderBottom:`1px solid ${th.border}`,padding:"13px 24px",display:"flex",alignItems:"center",gap:12}}>
        <button onClick={onBack} style={{background:th.surface2,border:`1px solid ${th.border}`,borderRadius:8,color:th.text2,padding:"7px 16px",cursor:"pointer",fontWeight:600,fontSize:13}}>{t.back}</button>
        <span style={{fontWeight:800,fontSize:18,color:th.text}}>üó∫Ô∏è {t.simulation}</span>
      </div>
      <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:32,gap:24}}>
        <div style={{textAlign:"center",marginBottom:8}}>
          <div style={{fontSize:36,marginBottom:8}}>üéØ</div>
          <div style={{color:th.text,fontWeight:900,fontSize:26,marginBottom:8}}>{t.chooseDifficulty}</div>
          <div style={{color:th.text3,fontSize:14}}>Ch·ªçn m·ª©c ƒë·ªô ph√π h·ª£p v·ªõi b·∫°n tr∆∞·ªõc khi v√†o M√¥ ph·ªèng</div>
        </div>
        <div style={{display:"flex",gap:18,flexWrap:"wrap",justifyContent:"center",maxWidth:900,width:"100%"}}>
          {opts.map(opt=>(
            <div key={opt.id} onClick={()=>setSelected(opt.id)} style={{
              flex:"1 1 220px",maxWidth:280,background:selected===opt.id?th.accentBg:th.surface,
              border:`2px solid ${selected===opt.id?th.accent:th.border}`,
              borderRadius:18,padding:24,cursor:"pointer",transition:"all 0.25s",
              boxShadow:selected===opt.id?`0 0 24px ${th.accent}44`:"none",
            }}>
              <div style={{fontSize:36,textAlign:"center",marginBottom:10}}>{opt.emoji}</div>
              <div style={{color:selected===opt.id?th.accent:th.text,fontWeight:800,fontSize:18,textAlign:"center",marginBottom:6}}>{opt.label}</div>
              <div style={{color:th.text3,fontSize:12,textAlign:"center",marginBottom:14,lineHeight:1.5}}>{opt.desc}</div>
              <div style={{display:"flex",flexDirection:"column",gap:5}}>
                {opt.stats.map((s,i)=><div key={i} style={{color:th.text2,fontSize:11,background:th.surface2,borderRadius:6,padding:"4px 8px"}}>{s}</div>)}
              </div>
            </div>
          ))}
        </div>
        <button onClick={()=>onStart(selected)} style={{
          background:`linear-gradient(135deg,${th.accent},${th.accent2})`,
          border:"none",borderRadius:14,color:"#fff",
          padding:"14px 48px",fontWeight:800,fontSize:16,cursor:"pointer",
          boxShadow:`0 4px 20px ${th.accent}55`,marginTop:8,
          transition:"transform 0.15s",
        }}>{t.startGame} ‚Üí</button>
      </div>
    </div>
  );
}

// ===================== MENU SCREEN =====================
function MenuScreen({onNav,player,th,t}) {
  return (
    <div style={{minHeight:"100vh",background:th.bg,fontFamily:"'Segoe UI',sans-serif"}}>
      <div style={{display:"flex",justifyContent:"flex-end",padding:"13px 28px",gap:12,background:th.headerBg,borderBottom:`1px solid ${th.border}`}}>
        {[{icon:"üî•",k:"streak",c:"#fb923c",val:player.streak},{icon:"üíé",k:"gems",c:"#38bdf8",val:player.gems},{icon:"üé´",k:"tickets",c:"#fbbf24",val:player.tickets}].map(x=>(
          <div key={x.k} style={{display:"flex",alignItems:"center",gap:6,background:th.surface2,borderRadius:20,padding:"6px 16px",color:x.c,fontWeight:700,fontSize:13}}>
            {x.icon} {x.k==="streak"?t.streak:x.k==="gems"?t.gem:t.ticket}: {x.val}
          </div>
        ))}
      </div>
      <div style={{display:"flex"}}>
        <div style={{width:220,minHeight:"calc(100vh - 53px)",background:th.headerBg,borderRight:`1px solid ${th.border}`,padding:"30px 0",display:"flex",flexDirection:"column",alignItems:"center"}}>
          <div style={{fontSize:32,fontWeight:900,color:th.accent,marginBottom:40,letterSpacing:-1}}>Fact<span style={{color:th.accent2}}>Up</span></div>
          {[
            {label:t.simulation,screen:"difficulty",icon:"üó∫Ô∏è"},
            {label:t.practice,screen:"practice",icon:"üß†"},
            {label:t.missions,screen:"menu",icon:"üìã"},
            {label:t.tools,screen:"menu",icon:"üîß"},
            {label:t.profile,screen:"profile",icon:"üë§"},
            {label:t.settings,screen:"settings",icon:"‚öôÔ∏è"},
          ].map(item=>(
            <button key={item.label} onClick={()=>onNav(item.screen)} style={{
              width:"82%",marginBottom:10,padding:"12px 0",
              background:th.surface2,border:`1px solid ${th.border}`,borderRadius:10,
              color:th.text2,fontSize:14,fontWeight:600,cursor:"pointer",
              display:"flex",alignItems:"center",justifyContent:"center",gap:8,transition:"all 0.2s",
            }}>{item.icon} {item.label}</button>
          ))}
        </div>
        <div style={{flex:1,display:"flex",gap:24,padding:32,alignItems:"flex-start",justifyContent:"center",flexWrap:"wrap"}}>
          {[
            {icon:"üíé",title:t.gemShop,desc:t.gemShopDesc,color:"#38bdf8",val:`${player.gems} Gem`},
            {icon:"üé´",title:t.gacha,desc:t.gachaDesc,color:"#f472b6",val:`${player.tickets} Ticket`},
          ].map(c=>(
            <div key={c.title} style={{flex:"1 1 280px",maxWidth:340,minHeight:380,background:th.surface,borderRadius:18,border:`1px solid ${th.border}`,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",cursor:"pointer",gap:14,padding:28}}>
              <div style={{fontSize:52}}>{c.icon}</div>
              <div style={{color:c.color,fontWeight:800,fontSize:18}}>{c.title}</div>
              <div style={{color:th.text3,textAlign:"center",fontSize:13,lineHeight:1.6}}>{c.desc}</div>
              <div style={{padding:"10px 24px",background:c.color+"18",border:`1px solid ${c.color}44`,borderRadius:10,color:c.color,fontWeight:700,fontSize:13}}>{c.val}</div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// ===================== PROFILE SCREEN =====================
function ProfileScreen({onBack,player,th,t}) {
  return (
    <div style={{minHeight:"100vh",background:th.bg,fontFamily:"'Segoe UI',sans-serif"}}>
      <div style={{padding:"13px 24px",background:th.headerBg,borderBottom:`1px solid ${th.border}`,display:"flex",alignItems:"center",gap:12}}>
        <button onClick={onBack} style={{background:th.surface2,border:`1px solid ${th.border}`,borderRadius:8,color:th.text2,padding:"7px 16px",cursor:"pointer",fontWeight:600,fontSize:13}}>{t.back}</button>
        <span style={{fontWeight:800,fontSize:18,color:th.text}}>{t.profile}</span>
      </div>
      <div style={{padding:40,display:"flex",justifyContent:"center"}}>
        <div style={{background:th.surface,border:`1px solid ${th.border}`,borderRadius:20,padding:32,maxWidth:700,width:"100%"}}>
          <div style={{display:"flex",gap:20,alignItems:"center",marginBottom:22}}>
            <div style={{width:88,height:88,borderRadius:16,background:th.surface2,display:"flex",alignItems:"center",justifyContent:"center",fontSize:40,border:`2px dashed ${th.accent}`,cursor:"pointer",flexShrink:0}}>üë§</div>
            <div style={{flex:1}}>
              <div style={{color:th.text,fontWeight:800,fontSize:22}}>{t.playerLabel}</div>
              <div style={{color:th.text3,fontSize:13,marginTop:4}}>{t.uid}: FCT-00001</div>
              <div style={{color:th.accent,fontSize:13,marginTop:2}}>{t.level}: {player.level}</div>
            </div>
          </div>
          <div style={{marginBottom:22}}>
            <div style={{display:"flex",justifyContent:"space-between",marginBottom:5}}>
              <span style={{color:th.text3,fontSize:12}}>XP</span><span style={{color:th.text3,fontSize:12}}>{player.xp}/100</span>
            </div>
            <div style={{background:th.surface2,borderRadius:99,height:8}}>
              <div style={{height:"100%",width:`${player.xp}%`,background:`linear-gradient(90deg,${th.accent},${th.accent2})`,borderRadius:99,transition:"width 0.5s"}}/>
            </div>
          </div>
          <div style={{display:"flex",gap:12,marginTop:18}}>
            {[{l:"GEM",v:player.gems,i:"üíé",c:"#38bdf8"},{l:"TICKET",v:player.tickets,i:"üé´",c:"#fbbf24"},{l:"STREAK",v:player.streak,i:"üî•",c:"#fb923c"}].map(s=>(
              <div key={s.l} style={{flex:1,background:th.surface2,borderRadius:12,padding:14,textAlign:"center",border:`1px solid ${th.border}`}}>
                <div style={{fontSize:22,marginBottom:4}}>{s.i}</div>
                <div style={{color:s.c,fontWeight:800,fontSize:20}}>{s.v}</div>
                <div style={{color:th.text3,fontSize:11,marginTop:2}}>{s.l}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// ===================== PRACTICE SCREEN =====================
function PracticeScreen({onBack,onXP,th,t}) {
  const [qi,setQi]=useState(0);
  const [sel,setSel]=useState([]);
  const [src,setSrc]=useState(null);
  const [verdict,setVerdict]=useState(null);
  const [flags,setFlags]=useState([]);
  const [methods,setMethods]=useState([]);
  const [checked,setChecked]=useState(false);
  const [fb,setFb]=useState(null);
  const q=PRACTICE_QS[qi];
  const total=PRACTICE_QS.length;

  const reset=()=>{setSel([]);setSrc(null);setVerdict(null);setFlags([]);setMethods([]);setChecked(false);setFb(null);};
  const next=()=>{if(qi<total-1){setQi(qi+1);reset();}else onBack();};
  const check=()=>{
    setChecked(true);
    let ok=false;
    if(q.type==="identify_flags") ok=sel.length===q.options.filter(o=>o.correct).length&&sel.every(i=>q.options[i].correct);
    if(q.type==="choose_source") ok=src!==null&&q.sources[src]&&q.sources[src].correct;
    if(q.type==="verify_methods") ok=methods.length===q.methods.filter(m=>m.correct).length&&methods.every(i=>q.methods[i]&&q.methods[i].correct);
    if(q.type==="classify_post") ok=verdict===q.correct_verdict;
    setFb(ok?"ok":"fail");
    if(ok) onXP(20);
  };

  const os=(isSel,isCorrect,show)=>{
    const bg=show?(isCorrect?"#22c55e22":isSel?"#ef444422":th.surface2):(isSel?th.accentBg:th.surface2);
    const bd=show?(isCorrect?"#22c55e":isSel?"#ef4444":th.border):(isSel?th.accent:th.border);
    return {background:bg,border:`1px solid ${bd}`,borderRadius:10,padding:"10px 14px",cursor:"pointer",transition:"all 0.2s",marginBottom:8,display:"flex",alignItems:"flex-start",gap:10};
  };

  return (
    <div style={{minHeight:"100vh",background:th.bg,fontFamily:"'Segoe UI',sans-serif"}}>
      <div style={{background:th.headerBg,borderBottom:`1px solid ${th.border}`,padding:"12px 24px",display:"flex",alignItems:"center",gap:16,position:"sticky",top:0,zIndex:10}}>
        <button onClick={onBack} style={{background:th.surface2,border:`1px solid ${th.border}`,borderRadius:8,color:th.text2,padding:"7px 16px",cursor:"pointer",fontWeight:600,fontSize:13}}>{t.back}</button>
        <div style={{flex:1}}>
          <div style={{fontSize:11,color:th.text3,marginBottom:4}}>{t.practiceTitle} ‚Äî {qi+1}/{total}</div>
          <div style={{background:th.surface2,borderRadius:99,height:8,overflow:"hidden"}}>
            <div style={{height:"100%",width:`${(qi/total)*100}%`,background:`linear-gradient(90deg,${th.accent},${th.accent2})`,borderRadius:99,transition:"width 0.5s"}}/>
          </div>
        </div>
      </div>
      <div style={{display:"flex",alignItems:"center",justifyContent:"center",padding:32,minHeight:"calc(100vh - 80px)"}}>
        <div style={{background:th.surface,borderRadius:20,border:`1px solid ${th.border}`,padding:36,maxWidth:780,width:"100%"}}>
          <h2 style={{color:th.text,fontWeight:800,fontSize:21,marginBottom:24}}>{q.title}</h2>

          {q.type==="identify_flags"&&(
            <div style={{display:"flex",gap:24,flexWrap:"wrap"}}>
              <div style={{flex:"1 1 260px",background:th.bg,borderRadius:14,padding:20}}>
                <div style={{color:th.text2,fontSize:14,lineHeight:1.9,whiteSpace:"pre-wrap"}}>{q.content}</div>
              </div>
              <div style={{flex:"1 1 260px"}}>
                <div style={{color:th.text3,fontSize:13,marginBottom:8}}>Tick c√°c d·∫•u hi·ªáu ƒë√°ng ng·ªù:</div>
                {q.options.map((opt,i)=>(
                  <label key={i} style={os(sel.includes(i),opt.correct,checked)}>
                    <input type="checkbox" checked={sel.includes(i)} onChange={()=>!checked&&setSel(s=>s.includes(i)?s.filter(x=>x!==i):[...s,i])} style={{accentColor:th.accent,marginTop:2,flexShrink:0}}/>
                    <span style={{color:th.text2,fontSize:14}}>{opt.text}</span>
                  </label>
                ))}
              </div>
            </div>
          )}

          {q.type==="choose_source"&&(
            <div style={{display:"flex",gap:24,flexWrap:"wrap"}}>
              <div style={{flex:"1 1 200px",background:th.bg,borderRadius:14,padding:20}}>
                <div style={{color:th.text3,fontSize:13,marginBottom:8}}>T√¨nh hu·ªëng:</div>
                <div style={{color:th.text2,fontSize:14,lineHeight:1.7}}>{q.scenario}</div>
              </div>
              <div style={{flex:"2 1 340px"}}>
                {q.sources.map((s,i)=>(
                  <label key={i} style={{...os(src===i,s.correct,checked),flexDirection:"column",alignItems:"flex-start"}}>
                    <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:4}}>
                      <input type="radio" name="src" checked={src===i} onChange={()=>!checked&&setSrc(i)} style={{accentColor:th.accent}}/>
                      <span style={{color:th.text,fontWeight:700,fontSize:14}}>{s.name}</span>
                      {checked&&s.correct&&<span style={{color:"#22c55e",fontSize:12}}>‚úì</span>}
                    </div>
                    <div style={{paddingLeft:22}}>{s.details.map((d,j)=><div key={j} style={{color:th.text3,fontSize:12}}>‚Ä¢ {d}</div>)}</div>
                  </label>
                ))}
              </div>
            </div>
          )}

          {q.type==="verify_methods"&&(
            <div style={{display:"flex",gap:24,flexWrap:"wrap"}}>
              <div style={{flex:"1 1 200px",background:th.bg,borderRadius:14,padding:20}}>
                <div style={{color:th.text3,fontSize:13,marginBottom:8}}>T√¨nh hu·ªëng:</div>
                <div style={{color:th.text2,fontSize:14,lineHeight:1.7}}>{q.scenario}</div>
              </div>
              <div style={{flex:"2 1 340px"}}>
                {q.methods.map((m,i)=>(
                  <label key={i} style={os(methods.includes(i),m.correct,checked)}>
                    <input type="checkbox" checked={methods.includes(i)} onChange={()=>!checked&&setMethods(s=>s.includes(i)?s.filter(x=>x!==i):[...s,i])} style={{accentColor:th.accent,flexShrink:0}}/>
                    <span style={{color:th.text2,fontSize:14}}>{m.text}</span>
                  </label>
                ))}
              </div>
            </div>
          )}

          {q.type==="classify_post"&&(
            <div style={{display:"flex",gap:24,flexWrap:"wrap"}}>
              <div style={{flex:"1 1 240px",background:th.bg,borderRadius:14,padding:16}}>
                <div style={{color:th.text2,fontSize:13,lineHeight:1.7}}>{q.post.caption}</div>
              </div>
              <div style={{flex:"1 1 260px",display:"flex",flexDirection:"column",gap:14}}>
                <div>
                  {q.flags.map((flag,i)=>(
                    <label key={i} style={os(flags.includes(flag),q.correct_flags.includes(flag),checked)}>
                      <input type="checkbox" checked={flags.includes(flag)} onChange={()=>!checked&&setFlags(f=>f.includes(flag)?f.filter(x=>x!==flag):[...f,flag])} style={{accentColor:th.accent,flexShrink:0}}/>
                      <span style={{color:th.text2,fontSize:14}}>{flag}</span>
                    </label>
                  ))}
                </div>
                <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                  {q.verdict_options.map(v=>(
                    <button key={v} onClick={()=>!checked&&setVerdict(v)} style={{...os(verdict===v,v===q.correct_verdict,checked),marginBottom:0,padding:"8px 16px"}}>
                      <span style={{color:th.text2,fontSize:13,fontWeight:600}}>{v}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {fb&&(
            <div style={{marginTop:20,padding:16,borderRadius:12,background:fb==="ok"?"#22c55e22":"#ef444422",border:`1px solid ${fb==="ok"?"#22c55e":"#ef4444"}`,color:fb==="ok"?"#86efac":"#fca5a5",fontSize:14}}>
              {fb==="ok"?t.correct:t.wrong}{q.explanation?` ${q.explanation}`:""}
            </div>
          )}

          <div style={{display:"flex",justifyContent:"flex-end",marginTop:24,gap:12}}>
            {!checked&&<button onClick={check} style={{background:th.accent,border:"none",borderRadius:10,color:"#fff",padding:"11px 28px",fontWeight:700,fontSize:14,cursor:"pointer"}}>{t.confirm}</button>}
            {checked&&<button onClick={next} style={{background:`linear-gradient(90deg,${th.accent},${th.accent2})`,border:"none",borderRadius:10,color:"#fff",padding:"11px 28px",fontWeight:700,fontSize:14,cursor:"pointer"}}>{qi<total-1?t.next:t.finish}</button>}
          </div>
        </div>
      </div>
    </div>
  );
}

// ===================== BUBBLE DETAIL PANEL =====================
function BubblePanel({bubble,ap,th,t,lang,onInvestigate,onClarify,onDismiss,onClose}) {
  const srcLabel=SOURCE_LABELS[bubble.source]?.[lang]||bubble.source;
  const isTrusted=bubble.source==="official"||bubble.source==="gov";
  return (
    <div style={{
      position:"fixed",inset:0,background:"#000b",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200,
      animation:"slide-up 0.2s ease",
    }}>
      <div style={{
        background:th.surface,border:`2px solid ${bubble.isFake?"#ef4444":"#22c55e"}`,
        borderRadius:20,padding:28,maxWidth:400,width:"90%",
        boxShadow:`0 8px 48px ${bubble.isFake?"#ef444444":"#22c55e44"}`,
      }}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <div style={{fontSize:22}}>{bubble.isFake?"‚ö†Ô∏è":"üìÑ"}</div>
          <button onClick={onClose} style={{background:th.surface2,border:`1px solid ${th.border}`,borderRadius:6,color:th.text3,width:28,height:28,cursor:"pointer",fontSize:16}}>√ó</button>
        </div>
        <div style={{color:th.text,fontWeight:700,fontSize:15,lineHeight:1.5,marginBottom:16}}>{bubble.title}</div>

        {bubble.investigated ? (
          <div style={{marginBottom:18}}>
            <div style={{color:th.text3,fontSize:12,marginBottom:6}}>üîç K·∫øt qu·∫£ ki·ªÉm tra ngu·ªìn:</div>
            <div style={{background:isTrusted?"#22c55e18":"#ef444418",border:`1px solid ${isTrusted?"#22c55e":"#ef4444"}`,borderRadius:10,padding:12}}>
              <div style={{color:isTrusted?"#86efac":"#fca5a5",fontWeight:700,fontSize:13,marginBottom:4}}>{srcLabel}</div>
              <div style={{color:isTrusted?"#86efac":"#fca5a5",fontSize:12}}>{isTrusted?t.trustworthy:t.untrustworthy}</div>
            </div>
          </div>
        ):(
          <div style={{color:th.text3,fontSize:12,marginBottom:18,background:th.surface2,padding:10,borderRadius:8}}>
            ‚ùì Ch∆∞a r√µ ngu·ªìn g·ªëc ‚Äî h√£y ki·ªÉm tra tr∆∞·ªõc khi x·ª≠ l√Ω
          </div>
        )}

        <div style={{display:"flex",flexDirection:"column",gap:8}}>
          {!bubble.investigated&&(
            <button onClick={onInvestigate} disabled={ap<2} style={{
              background:ap>=2?th.accentBg:th.surface2, border:`1px solid ${ap>=2?th.accent:th.border}`,
              borderRadius:10,color:ap>=2?th.accent:th.text3,padding:"10px 14px",cursor:ap>=2?"pointer":"not-allowed",
              fontWeight:700,fontSize:13,display:"flex",justifyContent:"space-between",
            }}>
              <span>üîç {t.investigate}</span>
              <span style={{opacity:0.7}}>2 AP{ap<2?" ‚ö†Ô∏è":""}</span>
            </button>
          )}
          {bubble.investigated&&!isTrusted&&(
            <button onClick={onClarify} disabled={ap<3} style={{
              background:ap>=3?"#22c55e22":th.surface2, border:`1px solid ${ap>=3?"#22c55e":th.border}`,
              borderRadius:10,color:ap>=3?"#86efac":th.text3,padding:"10px 14px",cursor:ap>=3?"pointer":"not-allowed",
              fontWeight:700,fontSize:13,display:"flex",justifyContent:"space-between",
            }}>
              <span>üì¢ {t.clarify}</span>
              <span style={{opacity:0.7}}>3 AP{ap<3?" ‚ö†Ô∏è":""}</span>
            </button>
          )}
          {bubble.investigated&&isTrusted&&(
            <button onClick={onDismiss} style={{
              background:"#22c55e22",border:"1px solid #22c55e",borderRadius:10,
              color:"#86efac",padding:"10px 14px",cursor:"pointer",fontWeight:700,fontSize:13,
            }}>‚úÖ B·ªè qua ‚Äî Tin ƒë√°ng tin c·∫≠y</button>
          )}
          <button onClick={onClose} style={{
            background:th.surface2,border:`1px solid ${th.border}`,borderRadius:10,
            color:th.text3,padding:"8px 14px",cursor:"pointer",fontSize:12,
          }}>ƒê√≥ng</button>
        </div>
      </div>
    </div>
  );
}

// ===================== GAME SCREEN =====================
function GameScreen({onBack,settings,difficulty,onXP,th,t}) {
  const cfg=DIFFICULTY[difficulty];
  const lang=settings.language;
  const cb=settings.colorBlind;

  const [date,setDate]=useState({d:1,m:1,y:2026});
  const [ap,setAP]=useState(cfg.apStart);
  const maxAP=10;
  const [zones,setZones]=useState(freshZones());
  const [selZ,setSelZ]=useState("facebook");
  const [log,setLog]=useState([]);
  const [over,setOver]=useState(false);
  const [won,setWon]=useState(false);
  const [selectedBubble,setSelectedBubble]=useState(null); // {bubble, zoneId}
  const [gameStarted,setGameStarted]=useState(false); // delay win/lose check
  const tick=useRef(0);
  const apT=useRef(0);
  const bubbleTick=useRef(0);
  const boostReduceRef=useRef({});
  const doneRef=useRef(false);
  const startDelay=useRef(0);
  const zonesRef=useRef(zones);
  zonesRef.current=zones;

  const addLog=useCallback((msg)=>{
    setDate(d=>{setLog(l=>[...l.slice(-24),{date:`${d.d}/${d.m}`,msg}]);return d;});
  },[]);

  // AP regen counter display
  const [apRegenCountdown,setApRegenCountdown]=useState(cfg.apRegenSec);

  useEffect(()=>{
    if(over) return;
    const iv=setInterval(()=>{
      if(doneRef.current) return;
      tick.current++;
      apT.current++;
      startDelay.current++;

      // AP regen
      const regenTick=cfg.apRegenSec;
      setApRegenCountdown(regenTick-(apT.current%regenTick));
      if(apT.current%regenTick===0){
        setAP(a=>Math.min(a+1,maxAP));
      }

      // Date tick
      if(tick.current%15===0) setDate(d=>{let{d:day,m:mo,y:yr}=d;day++;if(day>28){day=1;mo++;}if(mo>12){mo=1;yr++;}return{d:day,m:mo,y:yr};});

      // Bubble spawn
      bubbleTick.current++;
      if(bubbleTick.current>=cfg.bubbleInterval){
        bubbleTick.current=0;
        setZones(prev=>{
          const nx={...prev};
          // count active bubbles across all zones
          const totalBubbles=Object.values(nx).reduce((s,z)=>s+z.bubbles.length,0);
          if(totalBubbles<cfg.maxBubbles){
            const zoneIds=Object.keys(ZONES);
            const zoneId=zoneIds[Math.floor(Math.random()*zoneIds.length)];
            const z={...nx[zoneId],bubbles:[...nx[zoneId].bubbles]};
            // boost reduces fake spawn rate
            const boostMod=z.boostActive>0?0.4:1;
            const isFake=Math.random()<(cfg.fakeRatio*boostMod);
            const pool=NEWS_POOL.filter(n=>n.isFake===isFake);
            if(pool.length>0){
              const news=pool[Math.floor(Math.random()*pool.length)];
              const bx=20+Math.random()*60;
              const by=15+Math.random()*70;
              z.bubbles.push({...news,uid:Date.now()+Math.random(),x:bx,y:by,age:0,investigated:false});
              nx[zoneId]=z;
              if(isFake) addLog(`‚ö†Ô∏è Tin gi·∫£ xu·∫•t hi·ªán t·∫°i ${ZONES[zoneId].name}`);
            }
          }
          return nx;
        });
      }

      // Chaos update ‚Äî fake bubbles that linger increase chaos
      setZones(prev=>{
        const nx={};
        for(const id in prev){
          const z={...prev[id],bubbles:[...prev[id].bubbles]};
          // age bubbles
          const agedBubbles=z.bubbles.map(b=>({...b,age:b.age+1}));
          // old fake bubbles add chaos
          const chaosAdd=agedBubbles.filter(b=>b.isFake&&b.age>8).length*cfg.chaosRate*0.5
            + agedBubbles.filter(b=>b.isFake&&b.age>3).length*cfg.chaosRate*0.2;
          z.chaos=Math.min(100, z.chaos+chaosAdd);
          z.control=Math.max(0, z.control-chaosAdd*0.15);
          z.influence=Math.min(100, z.influence+chaosAdd*0.1);
          z.pressure=Math.min(100, z.pressure+chaosAdd*0.08);
          // decay chaos slowly over time (player reward for doing nothing sometimes)
          const decayChaos=cfg.chaosDecay*0.05;
          z.chaos=Math.max(0, z.chaos-decayChaos);
          // decrease boost timer
          if(z.boostActive>0) z.boostActive=z.boostActive-1;
          z.bubbles=agedBubbles;
          nx[id]=z;
        }

        // Win/lose check ‚Äî only after 3 seconds
        if(startDelay.current>3 && !doneRef.current){
          const allChaosLow=Object.values(nx).every(z=>z.chaos<=5)&&Object.values(nx).every(z=>z.bubbles.filter(b=>b.isFake).length===0);
          const allChaosHigh=Object.values(nx).every(z=>z.chaos>=90);
          if(allChaosHigh){doneRef.current=true;setOver(true);setWon(false);}
          // Win only if player has actively cleared things (start delay passed significantly)
          if(allChaosLow && startDelay.current>60){doneRef.current=true;setOver(true);setWon(true);}
        }
        return nx;
      });

    },1000);
    return ()=>clearInterval(iv);
  },[over,cfg,addLog]);

  const handleBubbleClick=(bubble,zoneId)=>{
    if(over) return;
    setSelectedBubble({bubble,zoneId});
  };

  const handleInvestigate=()=>{
    if(!selectedBubble||ap<2) return;
    setAP(a=>a-2);
    setZones(prev=>{
      const nx={...prev};
      const z={...nx[selectedBubble.zoneId],bubbles:[...nx[selectedBubble.zoneId].bubbles]};
      z.bubbles=z.bubbles.map(b=>b.uid===selectedBubble.bubble.uid?{...b,investigated:true}:b);
      nx[selectedBubble.zoneId]=z;
      return nx;
    });
    setSelectedBubble(s=>s?{...s,bubble:{...s.bubble,investigated:true}}:null);
    addLog(`üîç Ki·ªÉm tra ngu·ªìn t·∫°i ${ZONES[selectedBubble.zoneId].name}`);
    onXP(5);
  };

  const handleClarify=()=>{
    if(!selectedBubble||ap<3) return;
    setAP(a=>a-3);
    const zid=selectedBubble.zoneId;
    const buid=selectedBubble.bubble.uid;
    const bAge=selectedBubble.bubble.age||0;
    // Effectiveness degrades with age
    const eff=Math.max(0.3, 1-(bAge/30)*0.7);
    setZones(prev=>{
      const nx={...prev};
      const z={...nx[zid],bubbles:[...nx[zid].bubbles]};
      // Remove bubble
      z.bubbles=z.bubbles.filter(b=>b.uid!==buid);
      // Reduce chaos
      z.chaos=Math.max(0, z.chaos-cfg.clarifyEffect*eff);
      z.influence=Math.max(0, z.influence-8*eff);
      z.pressure=Math.max(0, z.pressure-6*eff);
      nx[zid]=z;
      return nx;
    });
    setSelectedBubble(null);
    if(eff<0.5) addLog(`üì¢ ƒê√≠nh ch√≠nh y·∫øu (tin ƒë√£ l√¢u) t·∫°i ${ZONES[zid].name}`);
    else addLog(`üì¢ ƒê√≠nh ch√≠nh th√†nh c√¥ng t·∫°i ${ZONES[zid].name}`);
    onXP(15);
  };

  const handleDismiss=()=>{
    if(!selectedBubble) return;
    const zid=selectedBubble.zoneId;
    const buid=selectedBubble.bubble.uid;
    setZones(prev=>{
      const nx={...prev};
      const z={...nx[zid],bubbles:[...nx[zid].bubbles]};
      z.bubbles=z.bubbles.filter(b=>b.uid!==buid);
      nx[zid]=z;
      return nx;
    });
    setSelectedBubble(null);
    addLog(`‚úÖ B·ªè qua tin uy t√≠n t·∫°i ${ZONES[zid].name}`);
  };

  const useBoost=()=>{
    if(ap<4){addLog(t.notEnoughAP);return;}
    setAP(a=>a-4);
    setZones(prev=>{
      const nx={...prev};
      const z={...nx[selZ]};
      z.boostActive=cfg.boostEffect;
      z.control=Math.min(100,z.control+15);
      z.pressure=Math.max(0,z.pressure-10);
      nx[selZ]=z;
      return nx;
    });
    addLog(`üõ° TƒÉng ki·ªÉm so√°t t·∫°i ${ZONES[selZ].name} (${cfg.boostEffect}s)`);
    onXP(5);
  };

  const restart=()=>{
    setZones(freshZones());setAP(cfg.apStart);setLog([]);
    setDate({d:1,m:1,y:2026});setOver(false);setWon(false);
    setSelectedBubble(null);
    doneRef.current=false;tick.current=0;apT.current=0;bubbleTick.current=0;startDelay.current=0;
    setApRegenCountdown(cfg.apRegenSec);
  };

  const sz=zones[selZ];
  const chaosL=toChaos(sz.chaos,lang);
  const influL=toInfluence(sz.influence,lang);
  const ctrlL=toControl(sz.control,lang);
  const presL=toPressure(sz.pressure,lang);

  const globalChaos=Object.values(zones).reduce((s,z)=>s+z.chaos,0)/4;
  const gi=()=>{const vi=globalChaos<=20?"·ªîn ƒë·ªãnh":globalChaos<=45?"Lo ng·∫°i":globalChaos<=70?"B·∫•t an":"Kh·ªßng ho·∫£ng";const en=globalChaos<=20?"Stable":globalChaos<=45?"Concerning":globalChaos<=70?"Anxious":"Crisis";return lang==="en"?en:vi;};

  const diffLabel={easy:"üü¢ D·ªÖ",normal:"üü° B√¨nh th∆∞·ªùng",hard:"üî¥ Kh√≥"}[difficulty];

  return (
    <div style={{height:"100vh",background:th.bg,fontFamily:"'Segoe UI',sans-serif",display:"flex",flexDirection:"column",overflow:"hidden"}}>
      {/* Header */}
      <div style={{background:th.headerBg,borderBottom:`1px solid ${th.border}`,padding:"8px 14px",display:"flex",alignItems:"center",gap:12,flexShrink:0,flexWrap:"wrap"}}>
        <button onClick={onBack} style={{background:th.surface2,border:`1px solid ${th.border}`,borderRadius:8,color:th.text2,padding:"5px 10px",cursor:"pointer",fontWeight:600,fontSize:11}}>{t.back}</button>
        <div style={{color:th.accent,fontWeight:700,fontSize:12}}>üìÖ {date.d.toString().padStart(2,"0")}/{date.m.toString().padStart(2,"0")}/{date.y}</div>
        <div style={{display:"flex",alignItems:"center",gap:6}}>
          <span style={{color:th.accent2,fontWeight:700,fontSize:12}}>‚ö° {ap}/{maxAP} AP</span>
          <APBar ap={ap} maxAP={maxAP} th={th}/>
          <span style={{color:th.text3,fontSize:10}}>+1 in {apRegenCountdown}s</span>
        </div>
        <div style={{flex:1}}/>
        {/* Global chaos bar */}
        <div style={{display:"flex",alignItems:"center",gap:7,minWidth:180}}>
          <span style={{color:th.text3,fontSize:10,whiteSpace:"nowrap"}}>üåê {t.chaosLevel}:</span>
          <div style={{flex:1,background:th.surface2,borderRadius:99,height:8,overflow:"hidden",minWidth:80}}>
            <div style={{height:"100%",width:`${globalChaos}%`,background:globalChaos<=30?"#22c55e":globalChaos<=60?"#eab308":"#ef4444",borderRadius:99,transition:"width 0.5s"}}/>
          </div>
          <span style={{color:globalChaos<=30?"#22c55e":globalChaos<=60?"#eab308":"#ef4444",fontSize:11,fontWeight:700}}>{Math.round(globalChaos)}%</span>
        </div>
        <span style={{fontSize:11,fontWeight:700,color:th.text3}}>{diffLabel}</span>
      </div>

      <div style={{flex:1,display:"flex",overflow:"hidden"}}>
        {/* Left panel */}
        <div style={{width:185,background:th.surface,borderRight:`1px solid ${th.border}`,padding:12,display:"flex",flexDirection:"column",gap:8,overflowY:"auto"}}>
          <div style={{color:th.accent,fontWeight:700,fontSize:13,borderBottom:`1px solid ${th.border}`,paddingBottom:7}}>{ZONES[selZ].icon} {ZONES[selZ].name}</div>
          {[{l:t.spreadSpeed,v:chaosL},{l:t.influence,v:influL},{l:t.control,v:ctrlL},{l:t.pressure,v:presL}].map(item=>(
            <div key={item.l}><div style={{color:th.text3,fontSize:10,marginBottom:3}}>{item.l}</div><Badge label={item.v.label} color={item.v.color}/></div>
          ))}
          {sz.boostActive>0&&<div style={{color:"#22c55e",fontSize:11,fontWeight:700}}>üõ° Boost: {sz.boostActive}s</div>}

          <div style={{borderTop:`1px solid ${th.border}`,paddingTop:10,marginTop:4}}>
            <div style={{color:th.text3,fontSize:10,marginBottom:7,fontWeight:700}}>K·ª∏NƒÇNG (ch·ªçn khu v·ª±c)</div>
            <button onClick={useBoost} disabled={ap<4} style={{
              width:"100%",marginBottom:7,padding:"9px 10px",
              background:ap>=4?th.surface2:th.bg,border:`1px solid ${ap>=4?th.border2:th.border}`,
              borderRadius:8,color:ap>=4?th.text2:th.text3,fontSize:11,
              cursor:ap>=4?"pointer":"not-allowed",display:"flex",justifyContent:"space-between",alignItems:"center",
            }}>
              <span>üõ° {t.boost}</span>
              <span style={{color:th.accent2,fontSize:10,fontWeight:700}}>4 AP</span>
            </button>
            <div style={{color:th.text3,fontSize:10,lineHeight:1.4,marginTop:4,padding:"6px 8px",background:th.surface2,borderRadius:6}}>
              üí° Click bong b√≥ng tin tr√™n b·∫£n ƒë·ªì ƒë·ªÉ d√πng <b style={{color:th.accent}}>Ki·ªÉm tra ngu·ªìn</b> v√† <b style={{color:th.accent}}>ƒê√≠nh ch√≠nh</b>
            </div>
          </div>

          <div style={{borderTop:`1px solid ${th.border}`,paddingTop:10,marginTop:4}}>
            <div style={{color:th.text3,fontSize:10,marginBottom:6}}>Bong b√≥ng khu v·ª±c n√†y:</div>
            <div style={{color:th.text,fontWeight:700,fontSize:18,textAlign:"center"}}>{sz.bubbles.length}</div>
            <div style={{color:sz.bubbles.filter(b=>b.isFake).length>0?"#ef4444":th.text3,fontSize:11,textAlign:"center"}}>
              {sz.bubbles.filter(b=>b.isFake).length} tin gi·∫£ ¬∑ {sz.bubbles.filter(b=>!b.isFake).length} tin th·∫≠t
            </div>
          </div>
        </div>

        {/* Map area */}
        <div style={{flex:1,position:"relative",overflow:"hidden",background:th.mapBg}}>
          <div style={{position:"absolute",inset:0,backgroundImage:`radial-gradient(circle,${th.mapDot} 1px,transparent 1px)`,backgroundSize:"44px 44px"}}/>
          {/* Connections */}
          <svg style={{position:"absolute",inset:0,width:"100%",height:"100%",pointerEvents:"none"}}>
            {[["facebook","tiktok"],["facebook","youtube"],["tiktok","instagram"],["youtube","instagram"]].map(([a,b])=>(
              <line key={a+b} x1={`${ZONES[a].x}%`} y1={`${ZONES[a].y}%`} x2={`${ZONES[b].x}%`} y2={`${ZONES[b].y}%`} stroke={th.border2} strokeWidth={1} strokeDasharray="6,6" opacity={0.4}/>
            ))}
          </svg>

          {/* Zone nodes */}
          {Object.values(ZONES).map(zone=>{
            const z=zones[zone.id];
            const c=zoneColor(z.chaos,cb);
            const isSel=selZ===zone.id;
            return (
              <div key={zone.id} onClick={()=>setSelZ(zone.id)} style={{
                position:"absolute",left:`${zone.x}%`,top:`${zone.y}%`,transform:"translate(-50%,-50%)",
                width:100,height:100,borderRadius:"50%",background:c+"1a",
                border:`3px solid ${isSel?th.text:c}`,
                display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",cursor:"pointer",
                boxShadow:`0 0 ${Math.max(6,z.chaos/3)}px ${c}55${isSel?`,0 0 0 4px ${c}30`:""}`,
                transition:"all 0.4s",zIndex:isSel?10:1,
              }}>
                <div style={{fontSize:22,marginBottom:1}}>{zone.icon}</div>
                <div style={{color:th.text,fontWeight:700,fontSize:11}}>{zone.name}</div>
                <div style={{color:c,fontSize:10,fontWeight:800}}>{Math.round(z.chaos)}%</div>
                <div style={{width:"55%",height:4,borderRadius:99,background:th.surface2,marginTop:3}}>
                  <div style={{height:"100%",width:`${z.chaos}%`,background:c,borderRadius:99,transition:"width 0.5s"}}/>
                </div>
                {z.boostActive>0&&<div style={{position:"absolute",top:-6,left:-6,background:"#22c55e",borderRadius:"50%",width:18,height:18,fontSize:10,display:"flex",alignItems:"center",justifyContent:"center"}}>üõ°</div>}
                {/* Bubble count badge */}
                {z.bubbles.length>0&&<div style={{position:"absolute",top:-8,right:-8,background:z.bubbles.filter(b=>b.isFake).length>0?"#ef4444":"#22c55e",borderRadius:"50%",width:22,height:22,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:900,color:"#fff",boxShadow:`0 0 6px ${z.bubbles.filter(b=>b.isFake).length>0?"#ef4444":"#22c55e"}`}}>{z.bubbles.length}</div>}
              </div>
            );
          })}

          {/* News Bubbles floating on map */}
          {Object.values(ZONES).map(zone=>{
            const z=zones[zone.id];
            return z.bubbles.map(bubble=>{
              const isOld=bubble.age>8;
              const isFake=bubble.isFake;
              const color=isFake?"#ef4444":"#22c55e";
              // position bubbles around the zone
              const offsetX=zone.x+(bubble.x-50)*0.25;
              const offsetY=zone.y+(bubble.y-50)*0.25;
              return (
                <div key={bubble.uid}
                  onClick={()=>handleBubbleClick(bubble,zone.id)}
                  style={{
                    position:"absolute",
                    left:`${Math.max(5,Math.min(93,offsetX))}%`,
                    top:`${Math.max(5,Math.min(90,offsetY))}%`,
                    transform:"translate(-50%,-50%)",
                    zIndex:50,
                    cursor:"pointer",
                    animation:`bubble-pop 0.35s ease`,
                  }}>
                  <div style={{
                    background:th.surface,
                    border:`2px solid ${color}`,
                    borderRadius:99,
                    padding:"5px 10px",
                    fontSize:11,
                    fontWeight:700,
                    color,
                    whiteSpace:"nowrap",
                    maxWidth:130,
                    overflow:"hidden",
                    textOverflow:"ellipsis",
                    boxShadow:`0 0 ${isOld?16:8}px ${color}${isOld?"99":"55"}`,
                    animation:isFake?(isOld?"bubble-pulse 1.2s ease-in-out infinite":"none"):"bubble-pulse-real 2s ease-in-out infinite",
                    position:"relative",
                  }}>
                    {isFake?"üì∞":"üìÑ"} {bubble.title.length>18?bubble.title.slice(0,18)+"‚Ä¶":bubble.title}
                    {bubble.investigated&&<span style={{marginLeft:4,fontSize:9}}>üîç</span>}
                    {isOld&&isFake&&<div style={{position:"absolute",top:-3,right:-3,background:"#ef4444",borderRadius:"50%",width:8,height:8}}/>}
                  </div>
                </div>
              );
            });
          })}

          {/* Warning overlay if chaos very high */}
          {globalChaos>75&&(
            <div style={{position:"absolute",top:12,left:"50%",transform:"translateX(-50%)",background:"#ef444422",border:"1px solid #ef4444",borderRadius:10,padding:"6px 18px",color:"#fca5a5",fontWeight:700,fontSize:12,zIndex:100,animation:"bubble-pulse 1s infinite"}}>
              ‚ö†Ô∏è {t.chaosWarning}
            </div>
          )}
        </div>

        {/* Right panel */}
        <div style={{width:175,background:th.surface,borderLeft:`1px solid ${th.border}`,padding:12,display:"flex",flexDirection:"column",gap:8,overflowY:"auto"}}>
          <div style={{color:th.accent2,fontWeight:700,fontSize:13,borderBottom:`1px solid ${th.border}`,paddingBottom:7}}>üåê {t.globalStatus}</div>
          {[{l:t.socialInfluence,v:gi()}].map(item=>(
            <div key={item.l}><div style={{color:th.text3,fontSize:10,marginBottom:2}}>{item.l}</div><div style={{color:th.text2,fontWeight:700,fontSize:12}}>{item.v}</div></div>
          ))}
          <div style={{borderTop:`1px solid ${th.border}`,paddingTop:8}}>
            <div style={{color:th.text3,fontSize:10,marginBottom:6}}>{t.zones}</div>
            {Object.values(ZONES).map(zone=>{
              const z=zones[zone.id];const c=zoneColor(z.chaos,cb);
              return (
                <div key={zone.id} onClick={()=>setSelZ(zone.id)} style={{marginBottom:10,cursor:"pointer",background:selZ===zone.id?th.surface2:"transparent",borderRadius:8,padding:"4px 6px"}}>
                  <div style={{display:"flex",alignItems:"center",gap:6}}>
                    <div style={{width:8,height:8,borderRadius:"50%",background:c,flexShrink:0}}/>
                    <span style={{color:th.text3,fontSize:11,flex:1}}>{zone.name}</span>
                    <span style={{color:c,fontSize:11,fontWeight:700}}>{Math.round(z.chaos)}%</span>
                  </div>
                  <div style={{display:"flex",gap:4,marginTop:4,paddingLeft:14}}>
                    {z.bubbles.filter(b=>b.isFake).length>0&&<span style={{background:"#ef444422",color:"#fca5a5",fontSize:9,borderRadius:4,padding:"1px 5px"}}>üì∞ {z.bubbles.filter(b=>b.isFake).length}</span>}
                    {z.bubbles.filter(b=>!b.isFake).length>0&&<span style={{background:"#22c55e22",color:"#86efac",fontSize:9,borderRadius:4,padding:"1px 5px"}}>üìÑ {z.bubbles.filter(b=>!b.isFake).length}</span>}
                  </div>
                </div>
              );
            })}
          </div>
          {/* Legend */}
          <div style={{borderTop:`1px solid ${th.border}`,paddingTop:8,marginTop:4}}>
            <div style={{color:th.text3,fontSize:9,marginBottom:4,fontWeight:700,letterSpacing:1}}>CH√ö TH√çCH</div>
            <div style={{color:"#fca5a5",fontSize:10,marginBottom:3}}>üì∞ Tin gi·∫£ ‚Äî click ƒë·ªÉ x·ª≠ l√Ω</div>
            <div style={{color:"#86efac",fontSize:10,marginBottom:3}}>üìÑ Tin th·∫≠t ‚Äî click ƒë·ªÉ ki·ªÉm tra</div>
            <div style={{color:th.text3,fontSize:10}}>üîç = ƒë√£ ki·ªÉm tra ngu·ªìn</div>
          </div>
        </div>
      </div>

      {/* Event log */}
      <div style={{height:72,background:th.surface,borderTop:`1px solid ${th.border}`,padding:"6px 14px",overflowY:"auto",flexShrink:0}}>
        <div style={{color:th.text3,fontSize:10,marginBottom:3}}>{t.eventLog}</div>
        {[...log].reverse().slice(0,5).map((e,i)=>(
          <div key={i} style={{color:th.text3,fontSize:10,marginBottom:1}}>
            <span style={{color:th.accent,marginRight:6}}>[{e.date}]</span>{e.msg}
          </div>
        ))}
      </div>

      {/* Bubble detail panel */}
      {selectedBubble&&(
        <BubblePanel
          bubble={selectedBubble.bubble}
          ap={ap}
          th={th} t={t} lang={lang}
          onInvestigate={handleInvestigate}
          onClarify={handleClarify}
          onDismiss={handleDismiss}
          onClose={()=>setSelectedBubble(null)}
        />
      )}

      {/* Game over overlay */}
      {over&&(
        <div style={{position:"fixed",inset:0,background:"#000b",display:"flex",alignItems:"center",justifyContent:"center",zIndex:300}}>
          <div style={{background:th.surface,border:`2px solid ${won?"#22c55e":"#ef4444"}`,borderRadius:24,padding:44,textAlign:"center",maxWidth:360}}>
            <div style={{fontSize:60,marginBottom:14}}>{won?"üèÜ":"üíÄ"}</div>
            <div style={{color:won?"#86efac":"#fca5a5",fontSize:26,fontWeight:900,marginBottom:8}}>{won?t.win:t.lose}</div>
            <div style={{color:th.text3,marginBottom:24,fontSize:13,lineHeight:1.6}}>{won?t.winMsg:t.loseMsg}</div>
            <div style={{display:"flex",gap:10,justifyContent:"center"}}>
              <button onClick={restart} style={{background:th.accent,border:"none",borderRadius:12,color:"#fff",padding:"11px 24px",fontWeight:700,fontSize:14,cursor:"pointer"}}>{t.playAgain}</button>
              <button onClick={onBack} style={{background:th.surface2,border:`1px solid ${th.border}`,borderRadius:12,color:th.text2,padding:"11px 24px",fontWeight:700,fontSize:14,cursor:"pointer"}}>{t.menu}</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ===================== ROOT APP =====================
function App() {
  const [settings,setSettings]=useState({...DEFAULT_SETTINGS});
  const [player,setPlayer]=useState(freshPlayer());
  const [screen,setScreen]=useState("menu");
  const [gameDifficulty,setGameDifficulty]=useState("normal");
  const th=getTheme(settings.theme);
  const t=T[settings.language];

  const saveSettings=(s)=>{
    if(s._reset){
      setPlayer(freshPlayer());
      const clean={...s};delete clean._reset;
      setSettings(clean);
    } else setSettings(s);
  };

  const earnXP=(amt)=>{
    setPlayer(p=>{
      let xp=p.xp+amt,level=p.level,gems=p.gems;
      if(xp>=100){xp-=100;level++;gems+=50;}
      return {...p,xp,level,gems};
    });
  };

  const nav=s=>setScreen(s);

  const startGame=(diff)=>{setGameDifficulty(diff);setScreen("game");};

  if(screen==="settings") return <SettingsScreen onBack={()=>nav("menu")} settings={settings} onSave={saveSettings}/>;
  if(screen==="difficulty") return <DifficultyScreen onStart={startGame} onBack={()=>nav("menu")} th={th} t={t}/>;
  if(screen==="game") return <GameScreen onBack={()=>nav("difficulty")} settings={settings} difficulty={gameDifficulty} onXP={earnXP} th={th} t={t}/>;
  if(screen==="practice") return <PracticeScreen onBack={()=>nav("menu")} onXP={earnXP} th={th} t={t}/>;
  if(screen==="profile") return <ProfileScreen onBack={()=>nav("menu")} player={player} th={th} t={t}/>;
  return <MenuScreen onNav={nav} player={player} th={th} t={t}/>;
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
  </script>
</body>
</html>